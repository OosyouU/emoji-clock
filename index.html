<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Moon Clock</title>
<script src="https://cdn.jsdelivr.net/npm/@twemoji/api@latest/dist/twemoji.min.js" crossorigin="anonymous"></script>
<style>
  body {
    margin: 0;
    padding: 0;
    background: #0b1026;
    display: flex;
    justify-content: center;
    align-items: center;
    overflow: hidden;
  }

  #output {
    font-family: "Apple Color Emoji","Segoe UI Emoji",monospace;
    white-space: pre;
    line-height: 1em;
    text-align: center;
  }

  canvas { display: none; }
</style>
</head>
<body>

<pre id="output"></pre>
<canvas id="mask"></canvas>

<script>
const moons = ["ğŸŒ‘","ğŸŒ’","ğŸŒ“","ğŸŒ”","ğŸŒ•","ğŸŒ–","ğŸŒ—","ğŸŒ˜"];


const canvas = document.getElementById("mask");
const ctx = canvas.getContext("2d");
const output = document.getElementById("output");

let block = 6;
let cw = 0;
let ch = 0;

// ãƒ–ãƒ­ãƒƒã‚¯å†…ã®æ˜ã‚‹ã•å¹³å‡
function getBlockBrightness(img, x0, y0, bsize){
  const vals = [];
  for(let y=0;y<bsize;y++){
    for(let x=0;x<bsize;x++){
      const xi = Math.max(0, Math.min(cw-1, x0+x));
      const yi = Math.max(0, Math.min(ch-1, y0+y));
      const i = (xi + yi*cw)*4;
      const bright = (img[i]+img[i+1]+img[i+2])/3;
      vals.push(bright);
    }
  }
  return vals;
}

// ãƒ–ãƒ­ãƒƒã‚¯ã‚’å³/å·¦/ä¸Š/ä¸‹ã«åˆ†ã‘ã¦æœˆã‚’åˆ¤å®š
function getMoonByBlock(vals){
  const size = Math.sqrt(vals.length);
  const mid = Math.floor(size/2);
  let left=0,right=0,top=0,bottom=0;
  for(let y=0;y<size;y++){
    for(let x=0;x<size;x++){
      const val = vals[x + y*size];
      if(x<size/2) left += val; else right += val;
      if(y<size/2) top += val; else bottom += val;
    }
  }
  left/=vals.length/2; right/=vals.length/2;
  top/=vals.length/2; bottom/=vals.length/2;
  const avg = vals.reduce((a,b)=>a+b,0)/vals.length;

  if(avg<50) return moons[0]; // ğŸŒ‘
  if(avg>200) return moons[4]; // ğŸŒ•
  
  if(right>left && top>bottom) return moons[2]; // ğŸŒ“
  if(left>right && top>bottom) return moons[6];  // ğŸŒ—
  if(right>left && bottom>top) return moons[1];  // ğŸŒ’
  if(left>right && bottom>top) return moons[5];  // ğŸŒ–
  if(top>bottom) return moons[3];               // ğŸŒ”
  if(bottom>top) return moons[7];              // ğŸŒ˜

  return moons[4]; // ãã®ã»ã‹ã¯æº€æœˆ
}

function resizeCanvasAndFont(){
  const w = window.innerWidth;
  const h = window.innerHeight;

  const cols = 140;
  const rows = 80

  const stepX = Math.floor(w / cols);
  const stepY = Math.floor(h / rows);
  block = step = Math.max(2, Math.min(stepX, stepY));

  const useCols = Math.floor(w / block);
  const useRows = Math.floor(h / block);

  cw = useCols * block;
  ch = useRows * block;

  canvas.width = cw;
  canvas.height = ch;

  output.style.fontSize = block + "px";
}

function render(){
  const now = new Date();
  const t = now.toLocaleTimeString("ja-JP", { hour12:false });

  // canvasæç”»
  ctx.fillStyle = "black";
  ctx.fillRect(0,0,cw,ch);

    // ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’ç”»é¢ã«åˆã‚ã›ã¦è¨ˆç®—
  const chars = t.length;           // 8
  const sizeByWidth = cw / chars;
  const sizeByHeight = ch * 0.6;
  const fontSize = Math.floor(Math.min(sizeByWidth, sizeByHeight));

//   const fontSize = Math.floor(ch*0.4);
ctx.save(); // â‘  ç¾çŠ¶ã®çŠ¶æ…‹ã‚’ä¿å­˜
const scaleX = 1.2
const scaleY = 3; // ç¸¦æ–¹å‘ã«1.5å€
ctx.translate(cw/2, ch/2); // â‘¡ Canvasã®ä¸­å¿ƒã«ç§»å‹•
ctx.scale(scaleX, scaleY);      // â‘¢ ç¸¦æ–¹å‘ã ã‘æ‹¡å¤§

ctx.textAlign = "center";
ctx.textBaseline = "middle";
ctx.font = `bold ${fontSize}px monospace`;
ctx.fillStyle = "white";
ctx.fillText(t, 0, 0);     // â‘£ translateã—ã¦ã„ã‚‹ã®ã§ (0,0) ã«æç”»

ctx.restore(); // â‘¤ çŠ¶æ…‹ã‚’å…ƒã«æˆ»ã™
  ctx.fillText(t, cw/2, ch/2);
  

const blockWidth = block;
const blockHeight = Math.floor(block); // ç¸¦é•·ã«

  const img = ctx.getImageData(0,0,cw,ch).data;

  let result = "";
  for(let y=0;y<ch;y+=block){
    for(let x=0;x<cw;x+=block){
      const vals = getBlockBrightness(img, x, y, block);
      const m = getMoonByBlock(vals);
      result += m;
    }
    result += "\n";
  }

  output.textContent = result;
}

window.addEventListener("resize",()=>{
  resizeCanvasAndFont();
  render();
});

resizeCanvasAndFont();
render();
setInterval(render,1000);
</script>


</body>
</html>
